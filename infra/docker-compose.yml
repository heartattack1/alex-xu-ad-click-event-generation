version: "3.9"
services:
  redpanda:
    image: redpandadata/redpanda:v23.3.16
    command:
      - redpanda
      - start
      - --smp
      - "1"
      - --reserve-memory
      - "0M"
      - --overprovisioned
      - --node-id
      - "0"
      - --kafka-addr
      - PLAINTEXT://0.0.0.0:9092
      - --advertise-kafka-addr
      - PLAINTEXT://redpanda:9092
      - --set
      - redpanda.auto_create_topics_enabled=true
    ports:
      - "9092:9092"

  clickhouse:
    image: clickhouse/clickhouse-server:23.8
    ports:
      - "8123:8123"
      - "9000:9000"
    volumes:
      - ./clickhouse/init.sql:/docker-entrypoint-initdb.d/init.sql:ro

  stream-aggregator:
    build:
      context: ..
      dockerfile: apps/stream-aggregator/Dockerfile
    environment:
      KAFKA_BOOTSTRAP: redpanda:9092
      INPUT_TOPIC: click-events
      AGGREGATES_TOPIC: ad-aggregates
      TOP_TOPIC: ad-top-n
      CLICKHOUSE_URL: jdbc:ch://clickhouse:8123/default
      DEDUP_TTL_MS: "600000"
      TOP_N: "10"
    depends_on:
      - redpanda
      - clickhouse

  query-service:
    build:
      context: ..
      dockerfile: apps/query-service/Dockerfile
    environment:
      CLICKHOUSE_HOST: clickhouse
      CLICKHOUSE_PORT: "9000"
    ports:
      - "8080:8080"
    depends_on:
      - clickhouse

  event-producer:
    build:
      context: ..
      dockerfile: apps/event-producer/Dockerfile
    environment:
      KAFKA_BOOTSTRAP: redpanda:9092
      INPUT_TOPIC: click-events
      EVENTS_PER_SEC: "5"
    depends_on:
      - redpanda
